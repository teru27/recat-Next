name: github pages

# masterãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã—ãŸã¨ãjobsã«è¨˜è¿°ã—ãŸæ“ä½œã‚’è¡Œã†
on:
  push:
    branches:
      - main

jobs:
  build-deploy:
    # ubuntu OS ã‚’ä»®æƒ³ãƒã‚·ãƒ³ä¸Šã«ç”¨æ„ã™ã‚‹
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v2

      # Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’è¡Œã†
      - name: setup node
        uses: actions/setup-node@v1
        with:
          node-version: "16.x"

      # npm install ã®éš›ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã†ã‚ˆã†è¨­å®š
      - name: Cache dependencies
        uses: actions/cache@v1
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # package.jsonã«åŸºã¥ãä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
      - name: install
        run: npm install --frozen-lockfile

      # Next.jsã‚¢ãƒ—ãƒªã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹
      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆç›´ä¸‹ã«.nextãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã§ãã‚‹
      - name: build
        run: npm run build

      # é™çš„ãªHTMLã¨ã—ã¦Next.jsã‚¢ãƒ—ãƒªã‚’ç”Ÿæˆã™ã‚‹
      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆç›´ä¸‹ã«outãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã§ãã‚‹
      # ãã®ãªã‹ã«ã€HTMLãƒ•ã‚¡ã‚¤ãƒ«ç¾¤ã¨ã€ãã‚Œã‚‰ãŒèª­ã¿è¾¼ã‚€JSãƒ•ã‚¡ã‚¤ãƒ«ç¾¤ã‚’åã‚ãŸ_nextãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚ã‚‹
      - name: export
        run: npm run export

      # ã—ã‹ã—GitHub Pagesã®ä»•æ§˜ã¨ã—ã¦_ã‹ã‚‰å§‹ã¾ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ãˆãš404ã¨ãªã‚‹
      # ã¤ã¾ã‚ŠHTMLã‹ã‚‰JSã‚’èª­ã¿è¾¼ã‚ãªã„
      # ã“ã‚Œã‚’å›é¿ã™ã‚‹ãŸã‚ã«.nojekyllãƒ•ã‚¡ã‚¤ãƒ«ã‚’outãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä½œã‚‹
      - name: add nojekyll
        run: touch ./out/.nojekyll

      - name: add vercel-ignore-build-step.sh
        run: touch ./out/vercel-ignore-build-step.sh

      - name: echo vercel-ignore-build-step.sh
        run: echo -n "echo "VERCEL_GIT_COMMIT_REF: $VERCEL_GIT_COMMIT_REF"

if [[ "$VERCEL_GIT_COMMIT_REF" == "main" ]] ; then
  # Proceed with the build
    echo "âœ… - Build can proceed"
  exit 1;

else
  # Don't build
  echo "ğŸ›‘ - Build cancelled"
  exit 0;
fi" > vercel-ignore-build-step.sh

      # gh-pagesãƒ–ãƒ©ãƒ³ãƒã«outãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸­èº«ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹
      # gh-pagesãƒ–ãƒ©ãƒ³ãƒã¯è‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã‚‹
      - name: deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out
